{% extends 'library/base.html' %}
{% load static %}

{% block title %}POS System - Student Login{% endblock %}

{% block content %}
<style>
body { margin:0; overflow:hidden; }
.fullscreen-container { position: fixed; top:0; left:0; width:100vw; height:100vh;
    background: url("{% static 'images/bg.jpg' %}") no-repeat center center fixed;
    background-size: cover; display:flex; flex-direction:column; justify-content:flex-end; align-items:center; padding-bottom:10vh; z-index:1;}
.logo-section { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; }
.hidden-input { opacity:0; pointer-events:none; transition:opacity 0.5s ease; }
.visible-input { opacity:1; pointer-events:all; transition:opacity 0.5s ease; }
.status-feedback { margin-top:1rem; font-weight:bold; text-align:center; font-size:1.25rem; }
.modal-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; z-index:50; display:none; }
.modal-content { background:white; padding:2rem; border-radius:1rem; max-width:400px; text-align:center; }
.modal-content p { margin-bottom:1.5rem; }
</style>

<div class="fullscreen-container">
    <div class="logo-section">
        <i class="fas fa-book-reader text-white text-9xl mb-8 animate-pulse"></i>
        <h1 class="text-white text-6xl font-bold mb-4">Library POS</h1>
        <p class="text-white text-2xl opacity-90">Point of Service System</p>
    </div>

    <div id="input-section" class="w-full max-w-2xl px-8 visible-input">
        <form id="login-form" method="post" class="space-y-6">
            {% csrf_token %}
            <div>
                <label class="block text-white text-xl font-semibold mb-4 text-center">
                    <i class="fas fa-id-card mr-2"></i>Enter Student ID
                </label>
                <input 
                    id="student-id-input"
                    type="text"
                    name="student_id"
                    autofocus
                    class="w-full px-8 py-6 text-3xl text-center border-4 border-white rounded-2xl bg-white bg-opacity-90 focus:bg-opacity-100 focus:outline-none transition"
                    placeholder="Student ID (e.g. 23-11797)"
                >
            </div>
        </form>
        <div class="mt-4 status-feedback" id="status-feedback"></div>
        <div class="mt-8 text-center">
            <p class="text-white text-sm opacity-75">
                <i class="fas fa-info-circle mr-2"></i>Scan QR code or tap NFC card to login quickly
            </p>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-overlay">
    <div class="modal-content">
        <p id="modal-message"></p>
    </div>
</div>
<script>
(function() {
    const inputField = document.getElementById('student-id-input');
    const statusFeedback = document.getElementById('status-feedback');
    const modalOverlay = document.getElementById('modal-overlay');
    const modalMessage = document.getElementById('modal-message');

    // Modal display
    function showModal(message) {
        modalMessage.textContent = message;
        modalOverlay.style.display = 'flex';
        setTimeout(() => {
            modalOverlay.style.display = 'none';
            inputField.value = '';
            inputField.classList.remove('ring-red-400','ring-green-400','ring-yellow-400');
            statusFeedback.textContent = '';
        }, 2500);
    }

    // Student ID validation function
    function validateStudentID(studentID) {
        const cleanID = studentID.trim();

        if (cleanID === "") return;

        fetch(`/validate_student_id/?student_id=${encodeURIComponent(cleanID)}`)
            .then(response => response.json())
            .then(data => {
                inputField.classList.remove('ring-red-400','ring-green-400','ring-yellow-400');

                if (data.valid && data.approved) {
                    inputField.classList.add('ring-4', 'ring-green-400');
                    statusFeedback.textContent = '✅ Valid ID! Redirecting...';
                    statusFeedback.className = 'status-feedback text-green-400';
                    
                    // Redirect safely after a short delay
                    setTimeout(() => {
                        window.location.href = `/pos/options/?student_id=${encodeURIComponent(cleanID)}`;
                    }, 600);
                } 
                else if (data.valid && !data.approved) {
                    inputField.classList.add('ring-4', 'ring-red-400');
                    showModal(data.reason || 'Student not approved.');
                } 
                else {
                    inputField.classList.add('ring-4', 'ring-red-400');
                    showModal(data.reason || 'Student not found.');
                }
            })
            .catch(err => {
                console.error("Validation error:", err);
                inputField.classList.add('ring-4', 'ring-yellow-400');
                statusFeedback.textContent = '⚠ Server error';
                statusFeedback.className = 'status-feedback text-yellow-400';
            });
    }

    // Auto validation after input (keyboard or scanner)
    let typingTimer = null;
    inputField.addEventListener('input', () => {
        if (typingTimer) clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
            validateStudentID(inputField.value);
        }, 400);
    });

})();
</script>

{% endblock %}
